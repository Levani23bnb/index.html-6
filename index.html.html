<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcGenesis - NFT Market</title>
    <!-- Ethers.js -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');
        
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #050505;
            color: #e2e8f0;
        }
        .font-cyber { font-family: 'Orbitron', sans-serif; }
        
        /* ·Éú·Éî·Éù·Éú·Éò·É° ·Éî·É§·Éî·É•·É¢·Éî·Éë·Éò */
        .neon-box {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(6, 182, 212, 0.3);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.1);
        }
        .neon-box:hover {
            border-color: rgba(6, 182, 212, 0.8);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.3);
        }

        /* ·Éö·Éù·Éê·Éì·Éî·É†·Éò */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #06b6d4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- ·Éú·Éê·Éï·Éò·Éí·Éê·É™·Éò·Éê -->
    <nav class="border-b border-gray-800 bg-black/90 backdrop-blur sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-cyber text-cyan-400 tracking-wider">ArcMarket</h1>
            <button id="connectBtn" onclick="connectWallet()" class="px-6 py-2 border border-cyan-500 text-cyan-400 rounded hover:bg-cyan-500/10 transition-all font-bold cursor-pointer">
                Connect Wallet
            </button>
        </div>
    </nav>

    <!-- ·Éõ·Éó·Éê·Éï·Éê·É†·Éò ·Éú·Éê·É¨·Éò·Éö·Éò -->
    <main class="container mx-auto px-6 py-12 space-y-16">

        <!-- 1. CREATE NFT SECTION -->
        <section id="create-section" class="max-w-xl mx-auto">
            <div class="neon-box p-8 rounded-2xl backdrop-blur-md">
                <h2 class="text-3xl font-cyber text-white mb-6 text-center">Create NFT</h2>
                
                <div class="space-y-5">
                    <!-- ·É°·É£·É†·Éê·Éó·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê -->
                    <div>
                        <label class="block text-gray-400 mb-2 text-sm uppercase tracking-wide">Upload Image</label>
                        <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-cyan-900/50 file:text-cyan-400
                            hover:file:bg-cyan-900
                            cursor-pointer bg-black/50 rounded-lg border border-gray-700 p-2
                        "/>
                    </div>

                    <!-- ·É°·Éê·ÉÆ·Éî·Éö·Éò -->
                    <div>
                        <label class="block text-gray-400 mb-2 text-sm uppercase tracking-wide">NFT Name</label>
                        <input type="text" id="nftName" placeholder="Enter NFT Name" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-cyan-500 transition-colors">
                    </div>

                    <!-- ·É§·Éê·É°·Éò -->
                    <div>
                        <label class="block text-gray-400 mb-2 text-sm uppercase tracking-wide">Price (USDC)</label>
                        <div class="relative">
                            <input type="number" id="nftPrice" placeholder="0.00" step="0.01" class="w-full bg-black/50 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-cyan-500 transition-colors pl-4">
                            <span class="absolute right-4 top-3 text-gray-500 text-sm font-bold text-cyan-500">USDC</span>
                        </div>
                    </div>

                    <!-- ·Éö·Éù·Éê·Éì·Éî·É†·Éò -->
                    <div id="mintLoader" class="loader"></div>

                    <!-- ·É¶·Éò·Éö·Éê·Éô·Éò -->
                    <button onclick="createAndPublish()" class="w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-lg uppercase tracking-wider transition-all shadow-[0_0_15px_rgba(6,182,212,0.4)] cursor-pointer">
                        Publish to Marketplace
                    </button>
                </div>
            </div>
        </section>

        <!-- 2. MARKETPLACE GRID -->
        <section>
            <h3 class="text-2xl font-cyber text-white mb-8 border-b border-gray-800 pb-4">Live Mints</h3>
            
            <div id="nftGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="text-gray-500 col-span-full text-center py-10">Connect wallet to view NFTs...</div>
            </div>
        </section>

    </main>

    <script>
        // ‚úÖ ·Éô·Éù·Éú·É§·Éò·Éí·É£·É†·Éê·É™·Éò·Éê
        const IMGBB_API_KEY = "63d767175510660601c37b75569477e6"; 
        const marketplaceAddress = "0x8e6fD58c5FB124BB884BF2888a3D826Fdb302C1F";
        const usdcAddress = "0x3600000000000000000000000000000000000000";

        const marketplaceABI = [
            "function createToken(string memory tokenURI, uint256 price) public payable returns (uint)",
            "function getAllNFTs() public view returns (tuple(uint256 tokenId, address seller, address owner, uint256 price, bool sold, string tokenURI)[])",
            "function buyItem(uint256 tokenId) public payable"
        ];

        let provider, signer, contract;
        let isConnected = false;

        // 1. ·É°·Éê·É§·É£·Éö·Éò·É° ·Éì·Éê·Éô·Éê·Éï·É®·Éò·É†·Éî·Éë·Éê (·Éí·Éê·Éú·Éê·ÉÆ·Éö·Éî·Éë·É£·Éö·Éò)
        async function connectWallet() {
            console.log("Connecting...");
            
            // ·É®·Éî·Éõ·Éù·É¨·Éõ·Éî·Éë·Éê: Ethers ·É©·Éê·Éò·É¢·Éï·Éò·É†·Éó·Éê?
            if (typeof ethers === 'undefined') {
                return alert("Ethers.js not loaded. Check internet.");
            }

            // ·É®·Éî·Éõ·Éù·É¨·Éõ·Éî·Éë·Éê: MetaMask ·Éê·É†·Éò·É°?
            if (typeof window.ethereum !== 'undefined') {
                try {
                    // ·Éû·Éò·É†·Éì·Éê·Éû·Éò·É†·Éò ·Éõ·Éù·Éó·ÉÆ·Éù·Éï·Éú·Éê
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    
                    // Ethers Setup
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    
                    const address = accounts[0];
                    console.log("Connected:", address);

                    // ·É¶·Éò·Éö·Éê·Éô·Éò·É° ·É®·Éî·É™·Éï·Éö·Éê
                    const btn = document.getElementById("connectBtn");
                    btn.innerText = address.slice(0,6) + "..." + address.slice(-4);
                    btn.className = "px-6 py-2 border border-green-500 text-green-400 rounded font-bold bg-green-900/20";
                    isConnected = true;
                    
                    // ·Éô·Éù·Éú·É¢·É†·Éê·É•·É¢·Éò·É° ·Éò·Éú·Éò·É™·Éò·Éê·Éö·Éò·Éñ·Éê·É™·Éò·Éê
                    contract = new ethers.Contract(marketplaceAddress, marketplaceABI, signer);
                    
                    // NFT-·Éî·Éë·Éò·É° ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê
                    loadNFTs();

                } catch (err) {
                    console.error("Connect Error:", err);
                    alert("Connection Failed: " + err.message);
                }
            } else {
                alert("Please install MetaMask!");
                window.open("https://metamask.io/", "_blank");
            }
        }

        // 2. ·É°·É£·É†·Éê·Éó·Éò·É° ·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê
        async function uploadImage(file) {
            const formData = new FormData();
            formData.append("image", file);
            
            try {
                let res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST", body: formData
                });
                let data = await res.json();
                return data.data.url;
            } catch (err) {
                console.error(err);
                alert("Image upload failed");
                return null;
            }
        }

        // 3. CREATE & PUBLISH
        async function createAndPublish() {
            if (!isConnected) return alert("Connect Wallet first!");
            
            const fileInput = document.getElementById("imageInput");
            const name = document.getElementById("nftName").value;
            const priceVal = document.getElementById("nftPrice").value;

            if (!fileInput.files[0] || !name || !priceVal) return alert("Please fill all fields!");

            const loader = document.getElementById("mintLoader");
            loader.style.display = "block";

            try {
                const imageUrl = await uploadImage(fileInput.files[0]);
                if (!imageUrl) throw new Error("Image upload failed");

                const priceWei = ethers.utils.parseEther(priceVal.toString());
                const listingFee = ethers.utils.parseEther("0.0025"); 

                console.log("Sending Transaction...");
                const tx = await contract.createToken(imageUrl, priceWei, { value: listingFee });
                
                console.log("Waiting for confirmation...");
                await tx.wait();

                alert("Published Successfully! üöÄ");
                
                // ·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éî·Éë·Éê
                document.getElementById("nftName").value = "";
                document.getElementById("nftPrice").value = "";
                fileInput.value = "";
                loadNFTs();

            } catch (err) {
                console.error("Mint Error:", err);
                alert("Error: " + (err.data?.message || err.message));
            } finally {
                loader.style.display = "none";
            }
        }

        // 4. ·É©·Éê·É¢·Éï·Éò·É†·Éó·Éï·Éê
        async function loadNFTs() {
            if (!contract) return;

            try {
                const items = await contract.getAllNFTs();
                const grid = document.getElementById("nftGrid");
                grid.innerHTML = "";

                if (items.length === 0) {
                    grid.innerHTML = '<div class="text-gray-500 col-span-full text-center">No NFTs found. Create one!</div>';
                    return;
                }

                items.forEach(item => {
                    if (item.sold) return;

                    const priceDisplay = ethers.utils.formatEther(item.price);

                    const html = `
                        <div class="neon-box rounded-xl overflow-hidden flex flex-col group bg-black">
                            <div class="h-64 overflow-hidden relative">
                                <img src="${item.tokenURI}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                                     onerror="this.src='https://via.placeholder.com/400x400?text=No+Image'">
                            </div>
                            
                            <div class="p-4 flex flex-col gap-3">
                                <div class="flex justify-between items-start">
                                    <h4 class="text-white font-bold truncate pr-2">NFT #${item.tokenId}</h4>
                                    <span class="text-cyan-400 font-cyber font-bold">${priceDisplay} USDC</span>
                                </div>
                                
                                <button onclick="mintItem('${item.tokenId}', '${priceDisplay}')" 
                                    class="w-full py-2 bg-white text-black font-bold rounded hover:bg-cyan-400 transition-colors uppercase tracking-wider text-sm mt-2 cursor-pointer">
                                    MINT NOW
                                </button>
                            </div>
                        </div>
                    `;
                    grid.innerHTML += html;
                });

            } catch (err) {
                console.error("Load error:", err);
            }
        }

        // 5. MINT / BUY
        async function mintItem(tokenId, priceEth) {
            if (!isConnected) return alert("Connect Wallet!");

            try {
                const priceWei = ethers.utils.parseEther(priceEth);
                const btn = event.target;
                
                btn.innerText = "PROCESSING...";
                btn.disabled = true;

                // Native Payment (ARC)
                const tx = await contract.buyItem(tokenId, { value: priceWei });
                await tx.wait();

                alert("Mint Successful! üéâ");
                loadNFTs();

            } catch (err) {
                console.error("Buy Error:", err);
                alert("Failed: " + (err.data?.message || err.message));
                
                event.target.innerText = "MINT NOW";
                event.target.disabled = false;
            }
        }
    </script>
</body>
</html>